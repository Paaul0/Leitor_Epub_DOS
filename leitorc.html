<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="leitorc.css">
    <title>Leitor</title>
</head>

<body>
    <header class="titulo">
        <p>Carregando livro...</p>
    </header>

    <side class="infos">
        <div class="home">
            <button class="btn">
                <img src="./icons/home.svg">
            </button>

            <div class="conf">
                <button class="btn">
                    <img src="./icons/search.svg">
                </button>
                <button class="btn">
                    <img src="./icons/menu2.svg">
                </button>
            </div>
        </div>
        <div class="info_liv">
            <p>oi</p>
        </div>
    </side>

    <aside class="toc">
        <div id="sumario-container"></div>
    </aside>

    <main class="leitor">
        <div id="leitor"></div>
    </main>

    <footer class="progresso">
        <div class="navegacao">
            <button id="anterior">Anterior</button>
            <span id="progresso-info"></span>
            <button id="proximo">Próximo</button>
        </div>
    </footer>

    <div id="context-menu">
        <button id="highlight-from-menu"><img src="icons/grifar.svg"></button>
        <button id="Copy"><img src="icons/copy.svg"></button>
        <button id="anotar"><img src="icons/anotar.svg"></button>
        <button id="dicionario"><img src="icons/dicionario.svg"></button>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

<script>
    const parametros = new URLSearchParams(window.location.search);
    const caminhoDoLivro = parametros.get('livro');

    const tituloEl = document.querySelector('.titulo p');
    const leitorEl = document.getElementById('leitor');
    const sumarioContainer = document.getElementById('sumario-container');
    const progressoInfo = document.getElementById('progresso-info');
    const navContainer = document.querySelector('.navegacao');
    const btnAnterior = document.getElementById("anterior");
    const btnProximo = document.getElementById("proximo");

    if (caminhoDoLivro) {
        const livro = ePub(caminhoDoLivro);
        const rendicao = livro.renderTo("leitor", {
            width: "100%",
            height: "100%",
            spread: "none"
        });

        rendicao.display();

        livro.ready.then(() => {
            const { title } = livro.packaging.metadata;
            tituloEl.textContent = title;
            document.title = title;
            const toc = livro.navigation.toc;
            const sumarioHtml = document.createElement('ul');
            toc.forEach(item => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.textContent = item.label.trim();
                a.href = item.href;
                li.appendChild(a);
                sumarioHtml.appendChild(li);
                a.addEventListener("click", (e) => {
                    e.preventDefault();
                    rendicao.display(item.href);
                });
            });
            sumarioContainer.appendChild(sumarioHtml);
        });

        livro.locations.generate(1600).then(() => {
            rendicao.on("relocated", (location) => {
                const percent = livro.locations.percentageFromCfi(location.start.cfi);
                const percentFormatado = Math.floor(percent * 100);
                progressoInfo.textContent = `${percentFormatado}%`;
            });
        });

        btnAnterior.addEventListener("click", () => rendicao.prev());
        btnProximo.addEventListener("click", () => rendicao.next());

        const contextMenu = document.getElementById("context-menu");

        const hideContextMenu = () => {
            contextMenu.style.display = 'none';
        };

        rendicao.on("selected", (cfiRange, contents) => {
            const selection = contents.window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText.length === 0) {
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const leitorRect = leitorEl.getBoundingClientRect();
            
            // --- Cálculo de Posição ---
            const top = leitorRect.top + rect.top + window.scrollY - contextMenu.offsetHeight - 60;
            let left = leitorRect.left + rect.left + window.scrollX + (rect.width - contextMenu.offsetWidth) / 2;

            // --- INÍCIO DA LÓGICA DE SEGURANÇA (NOVO) ---

            const viewportWidth = window.innerWidth; // Largura da janela do navegador
            const menuWidth = contextMenu.offsetWidth;

            // Se o menu estiver saindo pela esquerda (pouco provável, mas bom ter)
            if (left < 10) {
                left = 10;
            }

            // Se o menu estiver saindo pela direita (a causa do seu problema)
            if (left + menuWidth > viewportWidth) {
                left = viewportWidth - menuWidth - 10; // Encosta na borda direita com uma margem de 10px
            }
            
            // --- FIM DA LÓGICA DE SEGURANÇA ---


            contextMenu.style.top = `${top}px`;
            contextMenu.style.left = `${left}px`;
            contextMenu.style.display = "block";
            contextMenu.dataset.cfi = cfiRange;
            contextMenu.dataset.selectedText = selectedText;
        });

        window.addEventListener('click', hideContextMenu);
        rendicao.hooks.content.register((contents) => {
            contents.window.addEventListener('click', hideContextMenu);
        });

        contextMenu.addEventListener('click', (event) => {
            event.stopPropagation();
        });

        document.getElementById("highlight-from-menu").addEventListener("click", () => {
            const cfi = contextMenu.dataset.cfi;
            if (cfi) {
                rendicao.annotations.highlight(cfi, {}, () => {}, "highlight", { "fill": "yellow" });
            }
            hideContextMenu();
        });

        document.getElementById("Copy").addEventListener("click", () => {
            const textToCopy = contextMenu.dataset.selectedText;
            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    console.log("Texto copiado para a área de transferência!");
                }).catch(err => {
                    console.error("Erro ao copiar o texto: ", err);
                });
            }
            hideContextMenu();
        });

    } else {
        tituloEl.textContent = "Erro";
        leitorEl.innerHTML = "<h3>Nenhum livro selecionado.</h3><p>Por favor, volte para a seleção e escolha um livro para ler.</p>";
        navContainer.style.display = 'none';
        sumarioContainer.style.display = 'none';
    }
</script>

</body>

</html>